Ext.namespace("Toc.settings");Toc.settings.SettingsDialog=function(a){this.pnlModule=new Toc.settings.ModulePanel(a);this.pnlTheme=new Toc.settings.ThemePanel(a);this.pnlBackground=new Toc.settings.BackgroundPanel(a);this.pnlSidebar=new Toc.settings.SidebarPanel(a);this.tabPanel=new Ext.TabPanel({plain:true,frame:true,border:false,region:"center",activeTab:0,deferredRender:false,layoutOnTabChange:true,items:[this.pnlModule,this.pnlTheme,this.pnlBackground,this.pnlSidebar]});this.frmPanel=new Ext.FormPanel({layout:"border",region:"center",border:false,items:this.tabPanel});Toc.settings.SettingsDialog.superclass.constructor.call(this,{title:TocLanguage.DesktopSetting,iconCls:"services",id:"desktop-setting-win",width:600,height:500,layout:"border",resizable:false,plain:false,modal:false,shadow:false,items:this.frmPanel,manager:a.getDesktop().getManager(),buttons:[{text:TocLanguage.btnSave,handler:function(){if(a.isReady){this.save(a)}},scope:this},{text:TocLanguage.btnClose,handler:this.close,scope:this}]});this.on("beforeclose",function(){Ext.getCmp("x-traypanel-setting-btn").setDisabled(false)})};Ext.extend(Toc.settings.SettingsDialog,Ext.Window,{activeSidebarPanel:function(){this.tabPanel.activate(this.pnlSidebar)},save:function(a){Ext.MessageBox.show({msg:TocLanguage.saveDataMsg,progressText:TocLanguage.saveDataProgressText,width:300,wait:true,waitConfig:{interval:200},icon:"desktop-download"});var b=a.launchers;Ext.Ajax.request({url:Toc.CONF.CONN_URL,params:{module:"desktop_settings",action:"save_settings",autorun:Ext.encode(b.autorun),quickstart:Ext.encode(b.quickstart),contextmenu:Ext.encode(b.contextmenu),shortcut:Ext.encode(b.shortcut),theme:a.styles.theme,fontcolor:a.styles.fontcolor,wallpaper:a.styles.wallpaper,transparency:a.styles.transparency,backgroundcolor:a.styles.backgroundcolor,wallpaperposition:a.styles.wallpaperposition,sidebaropen:a.sidebaropened,sidebartransparency:a.styles.sidebartransparency,sidebarbackgroundcolor:a.styles.sidebarbackgroundcolor},callback:function(d,e,c){if(Ext.decode(c.responseText).success){Ext.MessageBox.hide();a.getDesktop().showNotification({title:TocLanguage.msgSuccessTitle,html:TocLanguage.saveDataSuccess});this.close()}else{Ext.MessageBox.hide();Ext.MessageBox.alert(TocLanguage.msgErrTitle,TocLanguage.connServerFailure)}},failure:function(){Ext.MessageBox.hide();Ext.MessageBox.alert(TocLanguage.msgErrTitle,TocLanguage.lostConnectionToServer)},scope:this})}});Toc.settings.BackgroundPanel=function(d){var l;var q;q=d.getDesktop();this.store=new Ext.data.JsonStore({baseParams:{module:"desktop_settings",action:"list_wallpapers"},fields:["code","name","thumbnail","path"],id:"code",root:"wallpapers",url:Toc.CONF.CONN_URL,autoLoad:true});this.store.on("load",function(t,s){if(s){f.setTitle(TocLanguage.defaultWallpapers+" ("+s.length+")");var r=d.styles.wallpaper;if(r){l.select(r)}}},this);var k=new Ext.XTemplate('<tpl for=".">','<div class="setting-view-thumb-wrap" id="{code}">','<div class="setting-view-thumb"><img src="{thumbnail}" title="{name}" /></div>',"<span>{shortName}</span></div>","</tpl>",'<div class="x-clear"></div>');l=new Ext.DataView({autoHeight:true,emptyText:TocLanguage.noWallpaperText,itemSelector:"div.setting-view-thumb-wrap",loadingText:TocLanguage.loadingText,singleSelect:true,overClass:"x-view-over",prepareData:function(r){r.shortName=Ext.util.Format.ellipsis(r.name,17);return r},store:this.store,tpl:k});l.on("selectionchange",h,this);var f=new Ext.Panel({baseCls:"collapse-group",border:false,cls:"setting-thumbnail-viewer",hideCollapseTool:true,id:"setting-wallpaper-view",items:l,title:"Default Wallpapers",titleCollapse:true});var c=new Ext.Panel({autoScroll:true,bodyStyle:"padding:10px",border:true,cls:"setting-card-subpanel",id:"wallpapers",items:f,margins:"10 10 10 10",region:"center"});var a=d.styles.wallpaperposition;var m=o("tile",a=="tile"?true:false,90,40);var p=o("center",a=="center"?true:false,200,40);var j=new Ext.Panel({border:false,height:140,id:"position",items:[{border:false,items:{border:false,html:TocLanguage.wallpaperPositionTitle},x:15,y:15},{border:false,items:{border:false,html:'<img class="bg-pos-tile" src="'+Ext.BLANK_IMAGE_URL+'" width="64" height="44" border="0" alt="" />'},x:15,y:40},m,{border:false,items:{border:false,html:'<img class="bg-pos-center" src="'+Ext.BLANK_IMAGE_URL+'" width="64" height="44" border="0" alt="" />'},x:125,y:40},p,{border:false,items:{border:false,html:TocLanguage.desktopBackgroundTitle},x:245,y:15},{border:false,items:new Ext.Button({handler:e,scope:this,text:TocLanguage.btnBackgroundColor}),x:245,y:40},{border:false,items:{border:false,html:TocLanguage.fontColorTitle},x:425,y:15},{border:false,items:new Ext.Button({handler:i,scope:this,text:TocLanguage.btnFontColor}),x:425,y:40}],layout:"absolute",region:"south",split:false});Toc.settings.BackgroundPanel.superclass.constructor.call(this,{title:TocLanguage.WallpaperSetting,layout:"border",border:false,items:[c,j]});function o(t,s,r,u){if(t){radio=new Ext.form.Radio({name:"position",inputValue:t,checked:s,x:r,y:u});radio.on("check",g,radio);return radio}}function e(){var r=new Ext.ux.ColorDialog({border:false,closeAction:"close",listeners:{select:{fn:b,scope:this,buffer:350}},manager:d.getDesktop().getManager(),resizable:false,title:"Color Picker"});r.show(d.styles.backgroundcolor)}function b(s,r){q.setBackgroundColor(r)}function i(){var r=new Ext.ux.ColorDialog({border:false,closeAction:"close",listeners:{select:{fn:n,scope:this,buffer:350}},manager:d.getDesktop().getManager(),resizable:false,title:"Color Picker"});r.show(d.styles.fontcolor)}function n(s,r){q.setFontColor(r)}function h(s,u){if(u.length>0){var r=s.getRecord(u[0]);if(r&&r.data.code&&r.data.path){var t={code:r.data.code,path:r.data.path};if(d.styles.wallpaper!=t.code){q.setWallpaper(t)}}}}function g(s,r){if(r===true){q.setWallpaperPosition(s.inputValue)}}};Ext.extend(Toc.settings.BackgroundPanel,Ext.Panel);Ext.override(Ext.tree.TreeNodeUI,{toggleCheck:function(b){var a=this.checkbox;if(a){a.checked=(b===undefined?!a.checked:b);this.fireEvent("checkchange",this.node,a.checked)}}});Toc.settings.ModulePanel=function(g){var b=new Ext.data.JsonReader({},["parent","text","id","autorun","contextmenu","quickstart","shortcut"]);CheckColumn=function(h){Ext.apply(this,h);if(!this.id){this.id=Ext.id()}this.renderer=this.renderer.createDelegate(this)};CheckColumn.prototype={init:function(h){this.grid=h;this.grid.on("render",function(){var i=this.grid.getView();i.mainBody.on("mousedown",this.onMouseDown,this)},this)},onMouseDown:function(n,m){if(m.className&&m.className.indexOf("x-grid3-cc-"+this.id)!=-1){n.stopEvent();var k=this.grid.getView().findRowIndex(m),h=this.grid.store.getAt(k),j=[];if(Ext.isEmpty(h.data.id)){for(var l=0;l<this.grid.getStore().getTotalCount();l++){var o=this.grid.getStore().getAt(l);if(o.data.parent==h.data.parent){if(m.className.indexOf("x-grid3-check-col-on")!=-1){o.set(this.dataIndex,false)}else{o.set(this.dataIndex,true)}j[j.length]=o}}}else{h.set(this.dataIndex,!h.data[this.dataIndex]);j[j.length]=h}Ext.each(j,function(p){switch(this.dataIndex){case"autorun":if(p.data[this.dataIndex]){this.items.launchers.autorun.push(p.data.id)}else{var r=this.items.launchers.autorun;var s=p.data.id;var q=0;while(q<r.length){if(r[q]==s){r.splice(q,1)}else{q++}}}break;case"quickstart":if(p.data[this.dataIndex]){this.items.desktop.addQuickStartButton(p.data.id,true)}else{this.items.desktop.removeQuickStartButton(p.data.id,true)}break;case"shortcut":if(p.data[this.dataIndex]){this.items.desktop.addShortcut(p.data.id,true)}else{this.items.desktop.removeShortcut(p.data.id,true)}break;case"contextmenu":if(p.data[this.dataIndex]){this.items.desktop.addContextMenu(p.data.id,true)}else{var r=this.items.launchers.contextmenu;s=p.data.id;if(r.length>=0){this.items.desktop.removeContextMenu(p.data.id,true)}else{p.set(this.dataIndex,true)}}break}p.commit()},this)}},renderer:function(i,j,h){j.css+=" x-grid3-check-col-td";return'<div class="x-grid3-check-col'+(i?"-on":"")+" x-grid3-cc-"+this.id+'">&#160;</div>'},groupRenderer:function(h){return String(h)}};var e=new CheckColumn({header:TocLanguage.colAutorun,dataIndex:"autorun",items:g});var d=new CheckColumn({header:TocLanguage.colQuickstart,dataIndex:"quickstart",items:g});var a=new CheckColumn({header:TocLanguage.colShortcut,dataIndex:"shortcut",items:g});var f=new CheckColumn({header:TocLanguage.colContextmenu,dataIndex:"contextmenu",items:g});var c=new Ext.grid.GridPanel({store:new Ext.data.GroupingStore({url:Toc.CONF.CONN_URL,baseParams:{module:"desktop_settings",action:"load_modules"},reader:b,autoLoad:true,sortInfo:{field:"id",direction:"ASC"},groupField:"parent"}),columns:[{header:"module",dataIndex:"parent",hidden:true},{header:TocLanguage.colModule,dataIndex:"text"},e,d,a,f],view:new Ext.grid.GroupingView({forceFit:true,groupTextTpl:'{text} ({[values.rs.length]} {[values.rs.length > 1 ? "Items" : "Item"]})'}),region:"center",plugins:[e,d,a,f],iconCls:"icon-grid"});Toc.settings.ModulePanel.superclass.constructor.call(this,{title:TocLanguage.ModulesSetting,layout:"border",region:"center",labelAlign:"left",border:false,bodyStyle:"background:transparent;",items:c})};Ext.extend(Toc.settings.ModulePanel,Ext.Panel,{onClick:function(b,a){alert("nihao")}});Toc.settings.ThemePanel=function(b){var j,h;j=b.getDesktop();this.app=b;function e(l,m){if(m.length>0){var k=l.getRecord(m[0]);if(k&&k.data.code&&k.data.path){var n={code:k.data.code,name:k.data.name,path:k.data.path};if(b.styles.theme!=n.code){j.setTheme(n)}}}}this.store=new Ext.data.JsonStore({baseParams:{module:"desktop_settings",action:"list_themes"},fields:["code","name","thumbnail","path"],id:"code",root:"themes",url:Toc.CONF.CONN_URL,autoLoad:true});this.store.on("load",function(l,k){if(k){c.setTitle(TocLanguage.availableTheme+" ("+k.length+")");var m=b.styles.theme;if(m){h.select(m)}}},this);var f=new Ext.XTemplate('<tpl for=".">','<div class="setting-view-thumb-wrap" id="{code}">','<div class="setting-view-thumb"><img src="{thumbnail}" title="{code}" /></div>',"<span>{shortName}</span></div>","</tpl>",'<div class="x-clear"></div>');h=new Ext.DataView({autoHeight:true,emptyText:TocLanguage.noThemeText,itemSelector:"div.setting-view-thumb-wrap",loadingText:TocLanguage.loadingText,singleSelect:true,overClass:"x-view-over",prepareData:function(k){k.shortName=Ext.util.Format.ellipsis(k.name,17);return k},store:this.store,tpl:f});h.on("selectionchange",e,this);var c=new Ext.Panel({border:false,cls:"setting-thumbnail-viewer",id:"setting-theme-view",items:h,title:"Default Themes",height:270,autoScroll:true});var i=new Ext.Panel({autoScroll:true,bodyStyle:"padding:10px",border:true,cls:"setting-card-subpanel",id:"themes",items:c,margins:"10 10 10 10",region:"center"});this.slider=d({handler:new Ext.util.DelayedTask(g,this),min:0,max:100,x:15,y:35,width:100});var a=new Ext.Panel({border:false,height:70,items:[{x:15,y:15,xtype:"label",text:TocLanguage.taskbarTransparency},this.slider.slider,this.slider.display],layout:"absolute",split:false,region:"south"});Toc.settings.ThemePanel.superclass.constructor.call(this,{title:TocLanguage.ThemeSetting,layout:"border",labelAlign:"left",border:false,items:[i,a]});function d(m){var t=m.handler,n=m.min,q=m.max,l=m.width||100,r=m.x,p=m.y;var k=new Ext.Slider({minValue:n,maxValue:q,width:l,x:r,y:p});var o=new Ext.form.NumberField({cls:"setting-percent-field",enableKeyEvents:true,maxValue:q,minValue:n,width:45,x:r+l+15,y:p-1});function s(w){var u=w.getValue();o.setValue(u);t.delay(100,null,null,[u])}k.on({change:{fn:s,scope:this},drag:{fn:s,scope:this}});o.on({keyup:{fn:function(w){var u=w.getValue();if(u!==""&&!isNaN(u)&&u>=w.minValue&&u<=w.maxValue){k.setValue(u)}},buffer:350,scope:this}});return{slider:k,display:o}}function g(k){j.setTransparency(k)}};Ext.extend(Toc.settings.ThemePanel,Ext.Panel,{onShow:function(){Toc.settings.ThemePanel.superclass.onShow.call(this);this.slider.slider.setValue(this.app.styles.transparency)}});Toc.settings.SidebarPanel=function(a){config={};config.title=TocLanguage.sidebarConfigTitle;config.app=a;config.desktop=a.getDesktop();config.layout="border";config.border=false;config.items=[this.buildGadgetsPanel(),this.buildDisplaySettingPanel(a)];Toc.settings.SidebarPanel.superclass.constructor.call(this,config)};Ext.extend(Toc.settings.SidebarPanel,Ext.Panel,{buildDisplaySettingPanel:function(b){var c=new Ext.Panel({border:false,height:140,layout:"absolute",region:"south",items:[{border:false,items:{border:false,html:TocLanguage.sidebarStateSettingTitle},x:15,y:15},{border:false,items:{xtype:"checkbox",name:"sidebar_opened",hideLabel:true,inputValue:true,checked:(b.sidebaropened&&!b.sidebarcollapsed),listeners:{check:this.onSidebarOpenedCheck,scope:this}},x:15,y:37},{border:false,items:{border:false,html:TocLanguage.sidebarTransparencySettingTitle},x:170,y:16},{border:false,items:this.buildTransparencySlider(),x:170,y:40},{border:false,items:{border:false,html:TocLanguage.sidebarChoseGroundColor},x:385,y:15},{border:false,items:this.btnBackgroundColor=new Ext.Button({text:TocLanguage.btnBackgroundColor,handler:this.onChangeBgColor,scope:this}),x:390,y:40}]});var a=new Ext.Panel({border:false,style:"padding:0 10px;",region:"south",items:{xtype:"fieldset",title:TocLanguage.sidebarSettingTitle,id:"sidebar-display-setting",style:"margin:0 0 10px 0;padding:0;height:110px;",items:[c]}});return a},onSidebarOpenedCheck:function(b,a){if(a){this.desktop.showSidebar();this.btnBackgroundColor.enable();this.sidebarSlider.slider.enable();this.sidebarSlider.displayPercent.enable()}else{this.desktop.hideSidebar();this.btnBackgroundColor.disable();this.sidebarSlider.slider.disable();this.sidebarSlider.displayPercent.disable()}},onShow:function(){Toc.settings.SidebarPanel.superclass.onShow.call(this);if(!this.app.sidebaropened){this.btnBackgroundColor.disable();this.sidebarSlider.slider.disable();this.sidebarSlider.displayPercent.disable()}this.sidebarSlider.slider.setValue(this.app.styles.sidebartransparency)},buildGadgetsPanel:function(){this.pnlGadgets=new Ext.Panel({id:"gadgets-view",region:"center",style:"padding:10px 10px;",border:false,items:{xtype:"fieldset",title:TocLanguage.sidebarGadgetsTitle,height:250,items:[this.buildGadgetsView()]}});return this.pnlGadgets},buildGadgetsView:function(){this.gadgetsView=new Ext.DataView({store:new Ext.data.Store({url:Toc.CONF.CONN_URL,baseParams:{module:"desktop_settings",action:"get_gadgets"},reader:new Ext.data.JsonReader({root:Toc.CONF.JSON_READER_ROOT,id:"code"},["code","type","icon","title","description","file"]),autoLoad:true}),tpl:new Ext.XTemplate('<tpl for=".">','<div class="thumb-wrap" id="{title}">','<div class="thumb"><img src="templates/default/desktop/gadgets/{code}/{icon}" title="{title}"></div>',"<span>{description}</span>","</div>","</tpl>",'<div class="x-clear"></div>'),autoWidth:true,multiSelect:true,overClass:"x-view-over",selectedClass:"x-view-selected",itemSelector:"div.thumb-wrap",plugins:new Ext.DataView.DragSelector({dragSafe:true}),emptyText:TocLanguage.sidebarNoGadgets,listeners:{render:function(){var a=new ImageDragZone(this.gadgetsView,{containerScroll:true,ddGroup:"GadgetsDD",scroll:false})},dblclick:function(a,b,c){this.app.desktop.sidebar.addGadget(a.getRecord(c).get("code"),true)},scope:this}});return this.gadgetsView},buildTransparencySlider:function(){this.sidebarSlider=this.createSlider({handler:new Ext.util.DelayedTask(this.updateSidebarTransparency,this),min:0,max:100,x:15,y:10,width:100});var a=new Ext.Panel({border:false,width:200,region:"south",height:30,items:[this.sidebarSlider.slider,this.sidebarSlider.displayPercent]});return a},createSlider:function(c){var i=c.handler,d=c.min,f=c.max,b=c.width||100,g=c.x,e=c.y;var a=new Ext.Slider({minValue:d,maxValue:f,width:b,x:g,y:e});var j=new Ext.form.NumberField({enableKeyEvents:true,cls:"setting-percent-field",maxValue:f,minValue:d,width:45,style:"position:absolute;left:118px;top:1px;"});var h=function(l){var k=l.getValue();j.setValue(k);i.delay(100,null,null,[k])};a.on({change:{fn:h,scope:this},drag:{fn:h,scope:this}});j.on({keyup:{fn:function(l){var k=l.getValue();if(k!==""&&!isNaN(k)&&k>=l.minValue&&k<=l.maxValue){a.setValue(k)}},buffer:350,scope:this}});return{slider:a,displayPercent:j}},onChangeBgColor:function(){var a=new Ext.ux.ColorDialog({border:false,closeAction:"close",listeners:{select:{fn:this.onColorSelect,scope:this,buffer:350}},manager:this.desktop.getManager(),resizable:false,title:"Color Picker"});a.show(this.app.styles.sidebarbackgroundcolor)},onColorSelect:function(b,a){if(this.app.sidebaropened){this.desktop.sidebar.setBackgroundColor(a)}},updateSidebarTransparency:function(a){if(this.app.sidebaropened){this.desktop.sidebar.setBackgroundTransparency(a)}}});